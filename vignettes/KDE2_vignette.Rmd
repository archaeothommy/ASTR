---
title: "Binary plot with kernel density estimation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Binary plot with kernel density estimation} 
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This vignette introduces the "Kde2" function which generates a binary plot with kernel density estimation.

Kernel density estimation (KDE) is a non-parametric method to transform continuous data into a smoothed probability density function. According to Hsu (2024) and Hsu et al. (2018) KDE has become popular in archaeological science publications mainly due to three advantages when analysing data:

1. They do not assume the normality of the data;
2. They can produce smoother distributions than conventional histograms, whose appearance is significantly affected by the choices of bin width and the start/end points of bins; and
3. They can represent data in a multidimensional space and enable users to effectively compare different datasets either graphically or mathematically (see De Ceuster et al. 2025 also for the advantages of the use of one-dimensional KDE’s).

## What is Kernel density estimation (KDE)?







# Examples
The following examples showcase the different visualisation and density estimate calculations for the geom_kde2d function. 

## Basic biplot 
library(readr)
ad <- read_csv("data-raw/ArgentinaDatabase.csv")
View(ad)

ggplot(ad, 
  aes(x = `206Pb/204Pb`, 
  y = `207Pb/204Pb`, 
  fill = `Mining site`)) + 
  geom_kde2d()
#'
#' # Adjusting quantiles to show deciles
#' ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, fill = Species)) +
#'   geom_kde2d(quantiles = 10, alpha = 0.5)
#'
#' # Using min_prob to show only density regions above the median
#' ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, fill = Species)) +
#'   geom_kde2d(quantiles = 10, min_prob = 0.5)
#'
#' # Creating an outline effect
#' ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +
#'   geom_kde2d(quantiles = 1, min_prob = 0, fill = NA)
#'
#'  # Creating an outline effect, and using coord_cartesian to expand the
#'  # plot area so the full KDE regions show without clipping
#' ggplot(iris, aes(x = Sepal.Length, y = Sepal.Width, color = Species)) +
#'   geom_kde2d(quantiles = 1, min_prob = 0, fill = NA) +
#'   coord_cartesian(xlim = c(4, 8.2), ylim = c(2, 4.5), clip = "off")
#'
#' # Example of fallback behavior
#' # Create a dataset where one group has too few points for density estimation
#' set.seed(123)
#' df <- data.frame(
#'   x = c(rnorm(50), rnorm(50, 5), rnorm(2, 10)),
#'   y = c(rnorm(50), rnorm(50, 5), rnorm(2, 10)),
#'   group = rep(c("A", "B", "C"), c(50, 50, 2))
#' )
#'
#' # A message will indicate that group "C" is plotted as points
#' ggplot(df, aes(x, y, fill = group, colour = group)) +
#'   geom_kde2d(alpha = 0.4) +
#'   theme_minimal()


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ASTR)
```

# Introduction

This vignette introduces the `geom_kde2d` function which generates a binary plot with kernel density estimation.

Kernel density estimation (KDE) is a non-parametric method to transform continuous data into a smoothed probability density function. According to Hsu (2024,Hsu et al. 2018) KDE has become popular in archeaological science publications mainly due to three advantages when analysing data:

They do not assume the normality of the data;
They can produce smoother distributions than conventional histograms, whose appearance is significantly affected by the choices of bin width and the start/end points of bins; and
They can represent data in a multidimensional space and enable users to effectively compare different datasets either graphically or mathematically (see De Ceuster et al. 2025 also for the advantages of the use of one-dimensional KDE’s).

# Examples
The following examples showcase the different visualisation and density estimate calculations for the geom_kde2d function. 

## Basic biplot 

```{r, fig.width=7, fig.height=8}
# load example Lead isotope data that is included with the package
data(ArgentinaDatabase)

library(ggplot2)

ggplot(ArgentinaDatabase, 
  aes(x = `206Pb/204Pb`, 
      y = `207Pb/204Pb`, 
  fill = `Mining site`)) + 
  geom_kde2d() +
  theme_minimal() +
  # move the legend under the plot so the
  # site names are fully legible
  theme(legend.position="bottom", 
        legend.direction="horizontal") +
  guides(fill = guide_legend(nrow = 10, 
               theme = theme(legend.byrow = TRUE)))
```
  
This example reads in the sample dataset and calculates the kernel density estimates in the function geom_kde2d(), colouring by the Mining site variable from the dataset. Warning messages appear for each group where the sample size is too small to calculate the estimates: No density estimate possible for group 'x' plotting points instead.
the leading minor of order 1 is not positive. In those cases, the plotting falls back to plotting individual points from the original dataset.

## Biplot with adjusted quantiles to show deciles
The default function reverts to 4 quantiles. This examples illustrates the quantiles set to 10 to show deciles.It also sets the transparency to 0.5. 

```{r}
ggplot(ArgentinaDatabase, 
  aes(x = `206Pb/204Pb`, 
      y = `207Pb/204Pb`, 
      fill = `Mining site`)) + 
  geom_kde2d(quantiles = 10, 
             alpha = 0.5)
```
  
## Biplot with the minimum probability argument added to show only density regions above the median

```{r}
ggplot(ArgentinaDatabase, 
  aes(x = `206Pb/204Pb`, 
      y = `207Pb/204Pb`, 
      fill = `Mining site`)) + 
  geom_kde2d(quantiles = 10, 
             min_prob = 0.5)
```
  
## Creation of an outline effect around the density region
For this effect the fill argument is set to NA

```{r}
ggplot(ArgentinaDatabase, 
  aes(x = `206Pb/204Pb`, 
      y = `207Pb/204Pb`, 
      colour = `Mining site`)) + 
  geom_kde2d(quantiles = 1, 
             min_prob = 0, 
             fill = NA)
```

##   Creation of an outline effect around the density region solving clipping issues
In some cases density regions can be clipped by the plot area. The addition of the `coord_cartesia`n function from ggplot2 expands the plot area so the full density regions are shown without clipping.The limits are set for the axes using the xlim and ylim arguments. 

```{r}
ggplot(ArgentinaDatabase, 
  aes(x = `206Pb/204Pb`, 
      y = `207Pb/204Pb`, 
      colour = `Mining site`)) + 
  geom_kde2d(quantiles = 1,
             min_prob = 0, 
             fill = NA) + 
  coord_cartesian(xlim = c(4, 8.2), 
                  ylim = c(2, 4.5), 
                  clip = "off")
```


